name: christmastree-webapp
metadata:
    template: azd-ctree@1.0.0
hooks:
  postprovision:
    shell: pwsh
    run: |
      # PowerShell script to register App Service and update Web App settings
      Write-Host "Registering App Service and updating Web App settings..."
      # Use resource group and web app name from Bicep outputs (injected as environment variables by azd)
      $resourceGroup = $env:RESOURCE_GROUP
      $webApp = $env:WEB_APP_NAME
      if (-not $resourceGroup) {
        Write-Error "RESOURCE_GROUP environment variable not set. Exiting."
        exit 2
      }
      if (-not $webApp) {
        Write-Error "WEB_APP_NAME environment variable not set. Exiting."
        exit 2
      }
      $tenantId = az account show --query tenantId -o tsv
      $appName = $webApp
      $existingApp = az ad app list --filter "displayName eq '$appName'" --query "[0].appId" -o tsv
      if (-not $existingApp) {
        Write-Host "Creating new application registration for $appName"
        $appRegRaw = az ad app create --display-name $appName --output json
        $appReg = $appRegRaw | ConvertFrom-Json
        $clientId = $appReg.appId
        if (-not $clientId) {
          Write-Error "Failed to retrieve Client ID from app registration. Exiting."
          exit 3
        }
        Write-Host "Application created with Client ID: $clientId"
        $endDate = (Get-Date).AddDays(10).ToString("yyyy-MM-dd")
        $secret = az ad app credential reset --id $clientId --append --end-date $endDate --query password -o tsv
      } else {
        Write-Host "Application already exists. Using existing application."
        $clientId = $existingApp
        $endDate = (Get-Date).AddDays(10).ToString("yyyy-MM-dd")
        $secret = az ad app credential reset --id $clientId --append --end-date $endDate --query password -o tsv
      }
      # Set additional environment variables for the Web App
      Write-Host "Setting environment variables for the Web App..."
      $treeRegion = $env:AZURE_LOCATION
      $treeContentSafetyKey = "" # Set this if available from deployment outputs or secrets
      az webapp config appsettings set --name $webApp --resource-group $resourceGroup --settings TREE_CLIENT_ID=$clientId TREE_TENANT_ID=$tenantId TREE_CLIENT_SECRET=$secret TREE_REGION=$treeRegion TREE_CONTENT_SAFETY_KEY=$treeContentSafetyKey
      Write-Host "Done."
services:
  ChristmasTreeWebApp:
    project: ./src
    language: js
    host: appservice
